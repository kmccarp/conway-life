<! doctype html>
<html>
	<head><title>Test</title>
		<style>
			.hide {
				display: none;
			}
			
			canvas {
				position: relative;
			}
		</style>
	</head>
	<body>
		<strong>Cycles</strong><br />
		<input type="number" value="-1" id="numCycles" hint="cycles" />
		<button id="go">Go!</button>
		<button id="stop" class="hide">Stop</button><br />
		<p>
			<input type="checkbox" id="diagnostic"/>Diagnostic Mode
			<span id="diagnosticInfo"></span>
		</p>
		<p id="remainingCyclesP" class="hide"><strong><span id="cyclesTitle"></span>: <span id="remainingCycles"></span></strong></p>
		<p id="results" class="hide"></p>
		<canvas width="750" height="500"></canvas><br />
		<button id="allDead">All Dead</button>
		<button id="allAlive">All Alive</button>
		<button id="randomize">Randomize</button>
	</body>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
	<script>
		var canvas = $('canvas').get(0)
		var ctx = canvas.getContext("2d")
		ctx.strokeStyle = '#222'
		ctx.fillStyle = 'blue'
		var zombie = 2
		var live = 1
		var dead = 0
		var colors = {}
		colors[dead] = 'black'
		colors[live] = '#3c3'
		colors[zombie] = 'red'
		var isRunning = false
		var mousedown = false
		var canvasWidth
		var canvasHeight
		var activeX = -1
		var activeY = -1
		var cellSize = 4
		var distanceBetweenCells = 0
		var currentPop = -1
		var cyclesAtCurrentPop = 0
		var maxCyclesForStabilization = 40
		var peopleKilled = 0
		var peopleBorn = 0
		var zombiesKilled = 0
		var peopleBecameZombies = 0
		
		var grid = []
		
		$('#go').click(function(e) {
			numCycles = $('#numCycles').val()
			$('#go').attr('disabled', 'disabled')
			$('#remainingCyclesP').removeClass('hide')
			$('#results').addClass('hide')
			$('#remainingCycles').html(numCycles)
			isRunning = true
			$('#stop').removeClass('hide')
			resetCounters();
			setTimeout(function() {cycle(0, numCycles)}, 10);
		})
		$('#stop').click(function(e) {
			isRunning = false
		})
		
		function complete(results) {
			isRunning = false
			$('#remainingCyclesP').addClass('hide')
			$('#results').html(results)
			$('#results').removeClass('hide')
			$('#stop').addClass('hide')
			$('#go').removeAttr('disabled')
			currentPop = -1
			cyclesAtCurrentPop = 0
		}
		
		function cycle(i, max) {
			if (!isRunning) {
				result = '<strong>People Killed: ' + peopleKilled + '</strong><br/>'
					+ '<strong>People Born: ' + peopleBorn + '</strong><br/>'
					+ '<strong>Zombies Killed: ' + zombiesKilled + '</strong><br/>'
					+ '<strong>People turned into zombies: ' + peopleBecameZombies + '</strong><br/>'
					+ 'Stopped manually after ' + i + ' cycles';
				complete(result);
				return;
			}
			if (i == max) { 
				result = '<strong>People Killed: ' + peopleKilled + '</strong><br/>'
					+ '<strong>People Born: ' + peopleBorn + '</strong><br/>'
					+ '<strong>Zombies Killed: ' + zombiesKilled + '</strong><br/>'
					+ '<strong>People turned into zombies: ' + peopleBecameZombies + '</strong><br/>'
					+ 'Completed after ' + i + ' cycles';
				complete(result);
				return;
			}
			pop = population()
			if (currentPop == pop) {
				if (++cyclesAtCurrentPop == maxCyclesForStabilization) {
					result = '<strong>People Killed: ' + peopleKilled + '</strong><br/>'
					+ '<strong>People Born: ' + peopleBorn + '</strong><br/>'
					+ '<strong>Zombies Killed: ' + zombiesKilled + '</strong><br/>'
					+ '<strong>People turned into zombies: ' + peopleBecameZombies + '</strong><br/>'
					+ 'Population stabilized at ' + pop + ' after ' + (i - maxCyclesForStabilization) + ' cycles.';
					complete(result);
					return;
				}
			}
			currentPop = pop
			if (max > -1) { $('#cyclesTitle').html('Remaining Cycles') } else { $('#cyclesTitle').html('Cycles iterated') }
			$('#remainingCycles').html(Math.abs(max - i - 1))
			console.log(max - i)
			newGrid = []
			for (x = 0; x < maxCols(); x++) {
				newGrid[x] = []
				for (y = 0; y < maxRows(); y++) {
					newGrid[x][y] = valueAfterCycle(x, y)
					incrementCounters(grid[x][y], newGrid[x][y])
				}
			}
			
			grid = newGrid
			draw()
			setTimeout(function() {cycle(i + 1, max)}, 10);
			return;
		}
		
		function resetCounters() {
			peopleKilled = 0
			peopleBorn = 0
			zombiesKilled = 0
			peopleBecameZombies = 0
		}
		
		function incrementCounters(currentValue, newValue) {
			switch(currentValue) {
				case live:
					switch (newValue) {
						case dead:
							peopleKilled++
							break;
						case zombie:
							peopleBecameZombies++
							break;
					}
					break;
				case dead:
					switch (newValue) {
						case live:
							peopleBorn++;
					}
					break;
				case zombie:
					switch (newValue) {
						case dead:
							zombiesKilled++;
					}
				break;
			}
		}
		
		$('canvas').mousedown(function(e) {
			mousedown = true
			i = Math.floor(offsetX(e) / cellSize)
			j = Math.floor(offsetY(e) / cellSize)
			if ($('#diagnostic').is(':checked') && !isRunning) {
				survive = '<strong style="color: blue'
				neighbors = liveNeighbors(i, j)
				willLive = valueAfterCycle(i, j)
				survive += '">' + (willLive == 2 ? 'zombie' : (willLive == 1 ? 'alive' : 'dead')) + '</strong>'
				text = "Will Become "
				$('#diagnosticInfo').html('(' + i + ',' + j + '):<br /><span style="color:green">'
					+ liveNeighbors(i, j) + " live neighbors. </span><br/>" 
					+ '<span style="color: red">' + zombieNeighbors(i, j) + ' zombie neighbors.</span><br/>' 
					+ text + " "  + survive)
			} else 
			if (!isRunning) {
				activeX = i
				activeY = j
				grid[i][j] = (grid[i][j] + 1) % Object.keys(colors).length
				drawRect(i, j)
			}
		})
		function offsetX(event) {
			if (event.offsetX != undefined) return event.offsetX
			if (event.layerX != undefined) return event.layerX
			return event.pageX - $('canvas').offset().left
		}
		
		function offsetY(event) {
			if (event.offsetY != undefined) return event.offsetY
			if (event.layerY != undefined) return event.layerY
			return event.pageY - $('canvas').offset().top
		}
		
		$('canvas').mousemove(function(e) {
			if (mousedown && !isRunning && !$('#diagnostic').is(':checked')) {
				i = Math.floor(offsetX(e) / cellSize)
				j = Math.floor(offsetY(e) / cellSize)
				if (activeX != i || activeY != j) {
					activeX = i
					activeY = j
					grid[i][j] = (grid[i][j] + 1) % Object.keys(colors).length
					drawRect(i, j)
				}
			}
		})
		
		$('canvas').mouseup(function(e) {
			mousedown = false
		})
		
		function maxRows() {
			return Math.floor(canvasHeight / cellSize)
		}
		
		function maxCols() {
			return Math.floor(canvasWidth / cellSize)
		}
		
		$('#allDead').click(function(e) {
			e.preventDefault()
			for(i = 0; i < maxCols(); i++) {
				for (j = 0; j < maxRows(); j++) {
					grid[i][j] = dead
				}
			}
			draw()
		});
		
		$('#allAlive').click(function(e) {
			e.preventDefault()
			for(i = 0; i < maxCols(); i++) {
				for (j = 0; j < maxRows(); j++) {
					grid[i][j] = live
				}
			}
			draw()
		});
		
		$('#randomize').click(function(e) {
			randomizeGrid()
		})
		
		function randomizeGrid() {
			for (i = 0; i < maxCols(); i ++) {
				grid[i] = []
				for (j = 0; j < maxRows(); j++) {
					rand = Math.random()
					alive = rand > 0.5
					grid[i][j] = alive ? live : dead
				}
			}
			
			draw()
		}
		
		$(function() {
			canvasWidth = $('canvas').width()
			canvasHeight = $('canvas').height()
			randomizeGrid()
		})
		
		function drawRect(i, j) {
			ctx.strokeStyle = "#222"
			ctx.fillStyle = colors[grid[i][j]]
			ctx.fillRect(i * Math.floor(canvasWidth / maxCols()), j * Math.floor(canvasHeight / maxRows()), Math.floor(canvasWidth / maxCols()) - distanceBetweenCells, Math.floor(canvasHeight / maxRows()) - distanceBetweenCells);
		}
		
		function draw() {
			for (i = 0; i < maxCols(); i++) {
				for (j = 0; j < maxRows(); j++) {
					drawRect(i, j);
				}
			}
		}
		
		function valueAfterCycle(i, j) {
			// zombies
			// if a zombie has three live neighbors, it will die
			// otherwise, it will remain a zombie
			if (zombie == grid[i][j]) { if (liveNeighbors(i, j) >= 3) { return dead } return zombie }
			
			numOfNeighbors = liveNeighbors(i, j)
			// if a live person has at least one zombie neighbor, and
			// four or fewer live neighbors, they become a zombie.
			if (grid[i][j] == live && zombieNeighbors(i, j) >= 1 && liveNeighbors(i, j) <= 3) return zombie
			// else, default rules apply
			if (numOfNeighbors == 3) return live
			if (grid[i][j] == live) { return numOfNeighbors == 2 ? live : dead}
			return dead;
		}
		
		function population() {
			pop = 0
			for (x = 0; x < grid.length; x++) {
				for (y = 0; y < grid[x].length; y++) {
					if (grid[x][y] == live) pop++
				}
			}
			return pop
		}
		
		function liveNeighbors(i, j) {
			rN = (i + 1) % grid.length
			lN = i - 1 < 0 ? grid.length - 1 : i - 1
			bN = (j + 1) % grid[i].length
			uN = j - 1 < 0 ? grid[i].length - 1 : j - 1
			neighbors = 0
			if (grid[rN][j] == live) neighbors++
			if (grid[lN][j] == live) neighbors++
			if (grid[rN][uN] == live) neighbors++
			if (grid[rN][bN] == live) neighbors++
			if (grid[lN][uN] == live) neighbors++
			if (grid[lN][bN] == live) neighbors++
			if (grid[i][uN] == live) neighbors++
			if (grid[i][bN] == live) neighbors++
			
			return neighbors
		}
		
		function zombieNeighbors(i, j) {
			rN = (i + 1) % grid.length
			lN = i - 1 < 0 ? grid.length - 1 : i - 1
			bN = (j + 1) % grid[i].length
			uN = j - 1 < 0 ? grid[i].length - 1 : j - 1
			neighbors = 0
			if (grid[rN][j] == zombie) neighbors++
			if (grid[lN][j] == zombie) neighbors++
			if (grid[rN][uN] == zombie) neighbors++
			if (grid[rN][bN] == zombie) neighbors++
			if (grid[lN][uN] == zombie) neighbors++
			if (grid[lN][bN] == zombie) neighbors++
			if (grid[i][uN] == zombie) neighbors++
			if (grid[i][bN] == zombie) neighbors++
			
			return neighbors
		}
	</script>
</html>