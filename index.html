<! doctype html>
<html>
	<head><title>Test</title>
		<style>
			.hide {
				display: none;
			}
		</style>
	</head>
	<body>
		<strong>Cycles</strong><br />
		<input type="number" value="500" id="numCycles" hint="cycles" />
		<button id="go">Go!</button>
		<button id="stop" class="hide">Stop</button><br />
		<p>
			<input type="checkbox" id="diagnostic"/>Diagnostic Mode
			<span id="diagnosticInfo"></span>
		</p>
		<p id="remainingCyclesP" class="hide"><strong>Remaining Cycles: <span id="remainingCycles"></span></strong></p>
		<p id="results" class="hide"></p>
		<canvas width="750" height="500"></canvas><br />
		<button id="allDead">All Dead</button>
		<button id="allAlive">All Alive</button>
		<button id="randomize">Randomize</button>
	</body>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
	<script>
		var canvas = $('canvas').get(0)
		var ctx = canvas.getContext("2d")
		ctx.strokeStyle = '#222'
		ctx.fillStyle = 'blue'
		var deadColor = 'black'
		var liveColor = '#3c3'
		var isRunning = false
		var mousedown = false
		var canvasWidth
		var canvasHeight
		var activeX = -1
		var activeY = -1
		var cellSize = 7
		var distanceBetweenCells = 0
		var currentPop = -1
		var cyclesAtCurrentPop = 0
		var maxCyclesForStabilization = 40
		
		var grid = []
		
		$('#go').click(function(e) {
			numCycles = $('#numCycles').val()
			$('#go').attr('disabled', 'disabled')
			$('#remainingCyclesP').removeClass('hide')
			$('#results').addClass('hide')
			$('#remainingCycles').html(numCycles)
			isRunning = true
			$('#stop').removeClass('hide')
			setTimeout(function() {cycle(0, numCycles)}, 10);
		})
		$('#stop').click(function(e) {
			isRunning = false
			complete('Life stopped manually');
		})
		
		function complete(results) {
			$('#remainingCyclesP').addClass('hide')
			$('#results').html(results)
			$('#results').removeClass('hide')
			$('#stop').addClass('hide')
			$('#go').removeAttr('disabled')
			currentPop = -1
			cyclesAtCurrentPop = 0
		}
		
		function cycle(i, max) {
			if (!isRunning) { complete('Stopped manually after ' + i + ' cycles'); return; }
			if (i == max) { isRunning = false; complete('Completed after ' + i + ' cycles'); return; }
			pop = population()
			if (currentPop == pop) {
				if (++cyclesAtCurrentPop == maxCyclesForStabilization) {
					complete('Population stabilized at ' + pop + ' after ' + (i - maxCyclesForStabilization) + ' cycles.')
					return;
				}
			}
			currentPop = pop
			$('#remainingCycles').html(max - i - 1)
			console.log(max - i)
			newGrid = []
			for (x = 0; x < maxCols(); x++) {
				newGrid[x] = []
				for (y = 0; y < maxRows(); y++) {
					newGrid[x][y] = isAliveAfterCycle(grid[x][y], liveNeighbors(x, y))
				}
			}
			
			grid = newGrid
			draw()
			setTimeout(function() {cycle(i + 1, max)}, 10);
			return;
		}
		
		$('canvas').mousedown(function(e) {
			mousedown = true
			i = Math.floor(e.offsetX / cellSize)
			j = Math.floor(e.offsetY / cellSize)
			if ($('#diagnostic').is(':checked') && !isRunning) {
				survive = '<strong style="color: '
				neighbors = liveNeighbors(i, j)
				willLive = isAliveAfterCycle(grid[i][j], neighbors)
				if (willLive) {survive += 'green'} else {survive += 'red'} 
				survive += '">' + willLive + '</strong>'
				text = grid[i][j] ? "Will Survive?" : "Will Grow?"
				$('#diagnosticInfo').html('(' + i + ',' + j + '): ' + liveNeighbors(i, j) + " live neighbors. " + text + " "  + survive)
			} else 
			if (!isRunning) {
				activeX = i
				activeY = j
				grid[i][j] = !grid[i][j]
				drawRect(i, j)
			}
		})
		
		$('canvas').mousemove(function(e) {
			if (mousedown && !isRunning && !$('#diagnostic').is(':checked')) {
				i = Math.floor(e.offsetX / cellSize)
				j = Math.floor(e.offsetY / cellSize)
				if (activeX != i || activeY != j) {
					activeX = i
					activeY = j
					grid[i][j] = !grid[i][j]
					drawRect(i, j)
				}
			}
		})
		
		$('canvas').mouseup(function(e) {
			mousedown = false
		})
		
		function maxRows() {
			return Math.floor(canvasHeight / cellSize)
		}
		
		function maxCols() {
			return Math.floor(canvasWidth / cellSize)
		}
		
		$('#allDead').click(function(e) {
			e.preventDefault()
			for(i = 0; i < maxCols(); i++) {
				for (j = 0; j < maxRows(); j++) {
					grid[i][j] = false
				}
			}
			draw()
		});
		
		$('#allAlive').click(function(e) {
			e.preventDefault()
			for(i = 0; i < maxCols(); i++) {
				for (j = 0; j < maxRows(); j++) {
					grid[i][j] = true
				}
			}
			draw()
		});
		
		$('#randomize').click(function(e) {
			randomizeGrid()
		})
		
		function randomizeGrid() {
			for (i = 0; i < maxCols(); i ++) {
				grid[i] = []
				for (j = 0; j < maxRows(); j++) {
					rand = Math.random()
					alive = rand > 0.5
					grid[i][j] = alive
				}
			}
			
			draw()
		}
		
		$(function() {
			canvasWidth = $('canvas').width()
			canvasHeight = $('canvas').height()
			randomizeGrid()
		})
		
		function drawRect(i, j) {
			ctx.strokeStyle = "#222"
			ctx.fillStyle = grid[i][j] ? liveColor : deadColor
			ctx.fillRect(i * Math.floor(canvasWidth / maxCols()), j * Math.floor(canvasHeight / maxRows()), Math.floor(canvasWidth / maxCols()) - distanceBetweenCells, Math.floor(canvasHeight / maxRows()) - distanceBetweenCells);
		}
		
		function draw() {
			for (i = 0; i < maxCols(); i++) {
				for (j = 0; j < maxRows(); j++) {
					drawRect(i, j);
				}
			}
		}
		
		function isAliveAfterCycle(isCurrentlyAlive, numOfNeighbors) {
			if (numOfNeighbors == 3) return true
			if (isCurrentlyAlive) { return numOfNeighbors == 2 }
			return false;
		}
		
		function population() {
			pop = 0
			for (x = 0; x < grid.length; x++) {
				for (y = 0; y < grid[x].length; y++) {
					if (grid[x][y]) pop++
				}
			}
			return pop
		}
		
		function liveNeighbors(i, j) {
			rN = (i + 1) % grid.length
			lN = i - 1 < 0 ? grid.length - 1 : i - 1
			bN = (j + 1) % grid[i].length
			uN = j - 1 < 0 ? grid[i].length - 1 : j - 1
			neighbors = 0
			if (grid[rN][j]) neighbors++
			if (grid[lN][j]) neighbors++
			if (grid[rN][uN]) neighbors++
			if (grid[rN][bN]) neighbors++
			if (grid[lN][uN]) neighbors++
			if (grid[lN][bN]) neighbors++
			if (grid[i][uN]) neighbors++
			if (grid[i][bN]) neighbors++
			
			return neighbors
		}
	</script>
</html>